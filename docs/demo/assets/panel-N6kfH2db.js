function Ue(){function e(Q,ze){if(!Q)throw new Error(`[dom] Missing #${ze}`);return Q}const n=e(document.getElementById("appRoot"),"appRoot"),o=e(document.getElementById("tabOverview"),"tabOverview"),t=e(document.getElementById("tabSettings"),"tabSettings"),r=e(document.getElementById("tabLogs"),"tabLogs"),l=e(document.getElementById("viewOverview"),"viewOverview"),a=e(document.getElementById("viewSettings"),"viewSettings"),s=e(document.getElementById("viewLogs"),"viewLogs"),u=e(document.getElementById("btnOvStart"),"btnOvStart"),c=e(document.getElementById("btnOvStop"),"btnOvStop"),f=e(document.getElementById("ovStatus"),"ovStatus"),E=e(document.getElementById("ovDomCount"),"ovDomCount"),v=e(document.getElementById("ovDomDelta"),"ovDomDelta"),m=e(document.getElementById("ovResCount"),"ovResCount"),g=e(document.getElementById("ovErrorCount"),"ovErrorCount"),i=e(document.getElementById("ovLongTaskCount"),"ovLongTaskCount"),d=e(document.getElementById("ovStressChart"),"ovStressChart"),b=e(document.getElementById("ovDomChart"),"ovDomChart"),y=e(document.getElementById("ovNetChart"),"ovNetChart"),D=e(document.getElementById("ovErrChart"),"ovErrChart"),k=e(document.getElementById("ovLongChart"),"ovLongChart"),Ee=e(document.getElementById("cfgShowDevTools"),"cfgShowDevTools"),he=e(document.getElementById("settingsGeneralStatus"),"settingsGeneralStatus"),Se=e(document.getElementById("devConfigDetails"),"devConfigDetails"),De=e(document.getElementById("cfgTraceConsole"),"cfgTraceConsole"),ye=e(document.getElementById("cfgActionLogMax"),"cfgActionLogMax"),we=e(document.getElementById("cfgDebugTraceMax"),"cfgDebugTraceMax"),Te=e(document.getElementById("cfgFailureLogsPerRun"),"cfgFailureLogsPerRun"),Ce=e(document.getElementById("logsCbDebug"),"logsCbDebug"),Le=e(document.getElementById("btnCfgResetDefaults"),"btnCfgResetDefaults"),ke=e(document.getElementById("cfgStatus"),"cfgStatus"),pe=e(document.getElementById("settingsVersion"),"settingsVersion"),Me=e(document.getElementById("settingsGitHubLink"),"settingsGitHubLink"),Ie=e(document.getElementById("logsLimit"),"logsLimit"),Pe=e(document.getElementById("btnLogsRefresh"),"btnLogsRefresh"),Re=e(document.getElementById("logsStatus"),"logsStatus"),Ae=e(document.getElementById("logsTrimKeep"),"logsTrimKeep"),Be=e(document.getElementById("btnLogsTrim"),"btnLogsTrim"),Oe=e(document.getElementById("btnLogsExport"),"btnLogsExport"),Ne=e(document.getElementById("btnLogsClear"),"btnLogsClear"),xe=e(document.getElementById("logsOut"),"logsOut"),_e=e(document.getElementById("debugLimit"),"debugLimit"),$e=e(document.getElementById("btnDebugRefresh"),"btnDebugRefresh"),Fe=e(document.getElementById("btnDebugExport"),"btnDebugExport"),Ve=e(document.getElementById("btnDebugClear"),"btnDebugClear"),Ge=e(document.getElementById("debugStatus"),"debugStatus"),je=e(document.getElementById("debugOut"),"debugOut");return{rootEl:n,tabOverview:o,tabSettings:t,tabLogs:r,viewOverview:l,viewSettings:a,viewLogs:s,btnOvStart:u,btnOvStop:c,ovStatusEl:f,ovDomCountEl:E,ovDomDeltaEl:v,ovResCountEl:m,ovErrorCountEl:g,ovLongTaskCountEl:i,ovStressChartEl:d,ovDomChartEl:b,ovNetChartEl:y,ovErrChartEl:D,ovLongChartEl:k,cfgShowDevToolsEl:Ee,settingsGeneralStatusEl:he,devConfigDetailsEl:Se,cfgTraceConsoleEl:De,cfgActionLogMaxEl:ye,cfgDebugTraceMaxEl:we,cfgFailureLogsPerRunEl:Te,logsCbDebugEl:Ce,btnCfgResetDefaults:Le,cfgStatusEl:ke,settingsVersionEl:pe,settingsGitHubLinkEl:Me,logsLimitEl:Ie,btnLogsRefresh:Pe,logsStatusEl:Re,logsTrimKeepEl:Ae,btnLogsTrim:Be,btnLogsExport:Oe,btnLogsClear:Ne,logsOutEl:xe,debugLimitEl:_e,btnDebugRefresh:$e,btnDebugExport:Fe,btnDebugClear:Ve,debugStatusEl:Ge,debugOutEl:je}}const Ke=new Set;function He(e){Ke.add(e)}function We(){const e=new Set;function n(t){return e.add(t),()=>e.delete(t)}function o(){He(r=>{for(const l of e)l(r)})}return{on:n,start:o}}function Je(e,n){let o="overview";function t(s){const u=c=>s===c;e.tabSettings.classList.toggle("is-active",u("settings")),e.tabSettings.setAttribute("aria-selected",String(u("settings"))),e.viewSettings.hidden=!u("settings"),e.tabOverview.classList.toggle("is-active",u("overview")),e.tabOverview.setAttribute("aria-selected",String(u("overview"))),e.viewOverview.hidden=!u("overview"),e.tabLogs.classList.toggle("is-active",u("logs")),e.tabLogs.setAttribute("aria-selected",String(u("logs"))),e.viewLogs.hidden=!u("logs")}function r(s){s!==o&&(n[o].unmount(),o=s,t(o),n[o].mount())}function l(){e.tabSettings.addEventListener("click",()=>r("settings")),e.tabOverview.addEventListener("click",()=>r("overview")),e.tabLogs.addEventListener("click",()=>r("logs"))}function a(){t(o),n[o].mount()}return{bind:l,boot:a,switchTo:r}}function Z(e){const n=e.items.length;return{items:e.items,counts:{items:n},meta:e.meta}}function Ye(){const e={items:[],meta:{}},n=new Set;function o(){const c=Z(e);for(const f of n)try{f(c)}catch{}}function t(){return Z(e)}function r(c){n.add(c);try{c(t())}catch{}return()=>n.delete(c)}function l(){e.items=[],e.meta={},o()}function a(c){e.meta.scopeUpdatedSince=c,o()}function s(){return String(e.meta.scopeUpdatedSince||"")}function u(c,f){e.items=c.slice(),e.meta.updatedTs=Date.now(),typeof(f==null?void 0:f.limit)=="number"&&(e.meta.limit=f.limit),o()}return{getSnapshot:t,subscribe:r,getScopeUpdatedSince:s,clearAll:l,setScopeUpdatedSince:a,setItems:u}}const Xe=new Set;function ie(e){for(const n of Xe)n(e,"local")}function M(e){const n=localStorage.getItem(e);if(n!==null)try{return JSON.parse(n)}catch{return n}}function qe(e,n){localStorage.setItem(e,JSON.stringify(n))}async function R(e){if(typeof e=="string")return{[e]:M(e)};if(Array.isArray(e)){const o={};for(const t of e)o[t]=M(t);return o}const n={};for(const[o,t]of Object.entries(e))n[o]=localStorage.getItem(o)!==null?M(o):t;return n}async function A(e){const n={};for(const[o,t]of Object.entries(e)){const r=M(o);qe(o,t),n[o]={oldValue:r,newValue:t}}ie(n)}async function X(e){const n=Array.isArray(e)?e:[e],o={};for(const t of n){const r=M(t);localStorage.removeItem(t),o[t]={oldValue:r,newValue:void 0}}ie(o)}const _="beezy-monitor.actionLog",Qe=5e3;function Ze(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function et(e){return Array.isArray(e)?e:[e]}function $(e,n,o){return Math.max(n,Math.min(o,Math.floor(e)))}async function I(){const e=await R(_),n=e==null?void 0:e[_];return Array.isArray(n)?n:[]}async function le(e){await A({[_]:e})}async function C(e,n){const o=$(Qe,100,5e4),r=et(e).map(u=>({...u,id:Ze(),ts:Date.now()}));if(!r.length)return{total:(await I()).length};const a=(await I()).concat(r),s=a.length>o?a.slice(a.length-o):a;return await le(s),{total:s.length}}async function tt(e){const n=$((e==null?void 0:e.limit)??200,1,5e4),o=$((e==null?void 0:e.offset)??0,0,1e6);let r=await I();e!=null&&e.kind&&(r=r.filter(s=>s.kind===e.kind)),e!=null&&e.scope&&(r=r.filter(s=>s.scope===e.scope)),typeof(e==null?void 0:e.sinceTs)=="number"&&(r=r.filter(s=>s.ts>=e.sinceTs)),typeof(e==null?void 0:e.untilTs)=="number"&&(r=r.filter(s=>s.ts<=e.untilTs));const l=r.length;r=r.slice().reverse();const a=r.slice(o,o+n);return{total:l,items:a}}async function nt(e){let o=await I();if(typeof e.beforeTs=="number"&&(o=o.filter(t=>t.ts>=e.beforeTs)),typeof e.keepLast=="number"){const t=$(e.keepLast,0,5e4);t===0?o=[]:o.length>t&&(o=o.slice(o.length-t))}return await le(o),{total:o.length}}async function ot(){await X(_)}async function rt(e){const n=await I();return JSON.stringify(n,null,2)}const P="beezy-monitor.debugTrace",H="beezy-monitor.debugTrace.enabled",st=2e3;function at(){return`${Date.now()}-${Math.random().toString(16).slice(2)}`}function W(e,n,o){return Math.max(n,Math.min(o,Math.floor(e)))}async function F(){const e=await R(P),n=e==null?void 0:e[P];return Array.isArray(n)?n:[]}async function it(e){await A({[P]:e})}async function q(){const e=await R(H);return!!(e!=null&&e[H])}async function ce(e){await A({[H]:!!e}),e||await X(P)}async function ue(){await X(P)}async function w(e,n){if(!await q())return{total:0};const t=W((n==null?void 0:n.max)??st,100,5e4),r=(Array.isArray(e)?e:[e]).map(u=>({...u,id:at(),ts:Date.now()}));if(!r.length)return{total:(await F()).length};const a=(await F()).concat(r),s=a.length>t?a.slice(a.length-t):a;return await it(s),{total:s.length}}async function ge(e){const n=W((e==null?void 0:e.limit)??200,1,5e4),o=W((e==null?void 0:e.offset)??0,0,1e6),t=(e==null?void 0:e.reverse)??!0,r=await F(),l=r.length,s=(t?r.slice().reverse():r).slice(o,o+n);return{total:l,items:s}}async function de(e){const n=await F();return JSON.stringify(n,null,e!=null&&e.pretty?2:0)}const fe=Object.freeze(Object.defineProperty({__proto__:null,append:w,clear:ue,exportJson:de,isEnabled:q,list:ge,setEnabled:ce},Symbol.toStringTag,{value:"Module"}));let V=0;function h(){return V>0}function T(e,n){if(n){lt(e);return}V=0,be(e,!1)}function lt(e){V++,V===1&&be(e,!0)}function be(e,n){e.rootEl.classList.toggle("is-busy",n),e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=n,e.cfgActionLogMaxEl.disabled=n,e.cfgDebugTraceMaxEl.disabled=n,e.cfgFailureLogsPerRunEl.disabled=n,e.btnCfgResetDefaults.disabled=n,e.logsCbDebugEl.disabled=n,e.logsLimitEl.disabled=n,e.btnLogsRefresh.disabled=n,e.logsTrimKeepEl.disabled=n,e.btnLogsTrim.disabled=n,e.btnLogsExport.disabled=n,e.btnLogsClear.disabled=n,e.debugLimitEl.disabled=n,e.btnDebugRefresh.disabled=n,e.btnDebugExport.disabled=n,e.btnDebugClear.disabled=n}const ee=60;function ct(e){const n=Math.min(e.dom/2e3,1)*25,o=Math.min(e.resPerMin/120,1)*25,t=Math.min(e.errPerMin/5,1)*25,r=Math.min(e.longPerMin/3,1)*25;return Math.round(n+o+t+r)}function ut(){let e=!1,n=null,o=null,t=null,r=null,l=0,a="Idle",s=[];function u(i){e=!!i}function c(i){a=i||""}function f(i){n=Number.isFinite(i)?Math.max(0,Math.floor(i)):null}function E(){n=null}function v(){s=[]}function m(i){s=[...s,i],s.length>ee&&(s=s.slice(s.length-ee))}function g(i,d){if(o=d,r&&l>0&&i>l){const b=(i-l)/1e3;if(b>.25){const y=Math.max(0,d.resTotal-r.resTotal),D=Math.max(0,d.errTotal-r.errTotal),k=Math.max(0,d.longTaskTotal-r.longTaskTotal);t={resPerMin:y*60/b,errPerMin:D*60/b,longTaskPerMin:k*60/b}}}r=d,l=i,n==null&&Number.isFinite(d.domNodes)&&f(d.domNodes)}return{get enabled(){return e},get baselineDomNodes(){return n},get totals(){return o},get rates(){return t},get status(){return a},get points(){return s},setEnabled:u,setStatus:c,setBaselineDomNodes:f,clearBaseline:E,clearPoints:v,pushPoint:m,setSample:g}}function p(e){return Number.isFinite(e)?String(Math.max(0,Math.floor(e))):"—"}function j(e){if(!Number.isFinite(e))return"—";const n=Math.max(0,e);return n>=100?String(Math.round(n)):n>=10?String(Math.round(n*10)/10):String(Math.round(n*100)/100)}function B(e,n){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()||n}function gt(){return{accent:B("--accent","#7aa2ff"),muted:B("--muted","rgba(255,255,255,0.68)"),border:B("--border","rgba(255,255,255,0.08)"),danger:B("--danger","#ff6b6b")}}function O(e){const n=e.getContext("2d");if(!n)throw new Error(`[overview] Canvas 2D context missing for #${e.id}`);const o=e.getAttribute("width")?Number(e.getAttribute("width")):e.clientWidth,t=e.getAttribute("height")?Number(e.getAttribute("height")):e.clientHeight,r=Number.isFinite(o)&&o>0?o:300,l=Number.isFinite(t)&&t>0?t:150,a=Math.max(1,Math.round(window.devicePixelRatio||1));return e.style.width=`${r}px`,e.style.height=`${l}px`,e.width=Math.floor(r*a),e.height=Math.floor(l*a),n.setTransform(a,0,0,a,0,0),{ctx:n,w:r,h:l,dpr:a}}function dt(e,n,o){e.clearRect(0,0,n,o)}function N(e,n,o,t){e.strokeStyle=t,e.lineWidth=1,e.strokeRect(.5,.5,n-1,o-1)}function ft(e,n,o,t){e.strokeStyle=t,e.lineWidth=1;const r=4;for(let s=1;s<=r;s++){const u=n*s/(r+1);e.beginPath(),e.moveTo(u+.5,0),e.lineTo(u+.5,o),e.stroke()}const l=o*.33,a=o*.66;e.beginPath(),e.moveTo(0,l+.5),e.lineTo(n,l+.5),e.stroke(),e.beginPath(),e.moveTo(0,a+.5),e.lineTo(n,a+.5),e.stroke()}function te(e,n,o,t,r,l,a,s=2){if(t.length<2)return;const u=Math.max(1e-9,l-r),c=n/Math.max(1,t.length-1);e.strokeStyle=a,e.lineWidth=s,e.lineJoin="round",e.lineCap="round",e.beginPath();for(let f=0;f<t.length;f++){const v=(t[f]-r)/u,m=f*c,g=o-v*o;f===0?e.moveTo(m,g):e.lineTo(m,g)}e.stroke()}function bt(e){let n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(const r of e)Number.isFinite(r)&&(r<n&&(n=r),r>o&&(o=r));if(!Number.isFinite(n)||!Number.isFinite(o))return{min:0,max:1};if(n===o)return{min:n-1,max:o+1};const t=(o-n)*.08;return{min:n-t,max:o+t}}function vt(e){const n=gt();function o(){e.ovDomCountEl.textContent="—",e.ovDomDeltaEl.textContent="",e.ovResCountEl.textContent="—",e.ovErrorCountEl.textContent="—",e.ovLongTaskCountEl.textContent="—";const l=[e.ovStressChartEl,e.ovDomChartEl,e.ovNetChartEl,e.ovErrChartEl,e.ovLongChartEl];for(const a of l){const{ctx:s,w:u,h:c}=O(a);s.clearRect(0,0,u,c),N(s,u,c,n.border)}}function t(l,a,s){if(!l){o();return}if(e.ovDomCountEl.textContent=p(l.domNodes),s==null)e.ovDomDeltaEl.textContent="";else{const u=Math.floor(l.domNodes-s);u===0?e.ovDomDeltaEl.textContent="Δ 0":u>0?e.ovDomDeltaEl.textContent=`Δ +${p(u)}`:e.ovDomDeltaEl.textContent=`Δ ${p(u)}`}a?(e.ovResCountEl.textContent=j(a.resPerMin),e.ovErrorCountEl.textContent=j(a.errPerMin),e.ovLongTaskCountEl.textContent=j(a.longTaskPerMin)):(e.ovResCountEl.textContent=p(l.resTotal),e.ovErrorCountEl.textContent=p(l.errTotal),e.ovLongTaskCountEl.textContent=p(l.longTaskTotal))}function r(l){if(!l||l.length<2){const v=[e.ovStressChartEl,e.ovDomChartEl,e.ovNetChartEl,e.ovErrChartEl,e.ovLongChartEl];for(const m of v){const{ctx:g,w:i,h:d}=O(m);g.clearRect(0,0,i,d),N(g,i,d,n.border)}return}const a=l.map(v=>v.stress),s=l.map(v=>v.dom),u=l.map(v=>v.resPerMin),c=l.map(v=>v.errPerMin),f=l.map(v=>v.longPerMin);{const{ctx:v,w:m,h:g}=O(e.ovStressChartEl);v.clearRect(0,0,m,g),ft(v,m,g,n.border),te(v,m,g,a,0,100,n.accent,2),N(v,m,g,n.border)}function E(v,m,g){const{ctx:i,w:d,h:b}=O(v);dt(i,d,b);const y=bt(m);te(i,d,b,m,y.min,y.max,g,2),N(i,d,b,n.border)}E(e.ovDomChartEl,s,n.accent),E(e.ovNetChartEl,u,n.accent),E(e.ovErrChartEl,c,n.danger),E(e.ovLongChartEl,f,n.accent)}return{setEmpty:o,render:t,renderCharts:r}}const z=5e3;function mt(){return Date.now()}function x(e,n=0){const o=Number(e);return Number.isFinite(o)?o:n}function Et(){return"("+(function(){var e,n,o;try{const t=window;if(!t.__beezyMonitor){t.__beezyMonitor={errTotal:0,longTaskTotal:0,_origConsoleError:null,_perfObsLong:null};try{const u=t.console;u&&typeof u.error=="function"&&(t.__beezyMonitor._origConsoleError=u.error.bind(u),u.error=function(...c){try{t.__beezyMonitor.errTotal++}catch{}return t.__beezyMonitor._origConsoleError(...c)})}catch{}try{if("PerformanceObserver"in t){const u=t.PerformanceObserver,c=new u(f=>{var E;try{const v=((E=f.getEntries)==null?void 0:E.call(f))||[];t.__beezyMonitor.longTaskTotal+=v.length}catch{}});c.observe({entryTypes:["longtask"]}),t.__beezyMonitor._perfObsLong=c}}catch{}}const r=document.getElementsByTagName("*").length;let l=0;try{const u=t.performance;l=(((e=u==null?void 0:u.getEntriesByType)==null?void 0:e.call(u,"resource"))||[]).length}catch{}const a=Number(((n=t.__beezyMonitor)==null?void 0:n.errTotal)||0),s=Number(((o=t.__beezyMonitor)==null?void 0:o.longTaskTotal)||0);return{ok:!0,domNodes:r,resTotal:l,errTotal:a,longTaskTotal:s}}catch(t){return{ok:!1,error:String((t==null?void 0:t.message)||t||"unknown error")}}}).toString()+")()"}async function ht(e){var n,o;try{const t=(o=(n=globalThis==null?void 0:globalThis.chrome)==null?void 0:n.devtools)==null?void 0:o.inspectedWindow;return t!=null&&t.eval?await new Promise(r=>{t.eval(e,(l,a)=>{if(a&&a.isException){r({ok:!1,error:String(a.value||a.description||"Eval exception")});return}r({ok:!0,value:l})})}):{ok:!1,error:"chrome.devtools.inspectedWindow.eval unavailable."}}catch(t){return{ok:!1,error:String((t==null?void 0:t.message)||t||"Eval failed")}}}function St(e,n){const o=ut(),t=vt(e);let r=null,l=!1,a=!1;function s(d){e.btnOvStart.disabled=d||h(),e.btnOvStop.disabled=!d||h()}function u(d){o.setStatus(d),e.ovStatusEl.textContent=d||""}async function c(){if(!l||!o.enabled)return;const d=await ht(Et());if(!d.ok){u("Eval failed"),s(!0),C({kind:"error",scope:"overview",message:"Failed to read metrics from inspected page.",ok:!1,error:d.error||"unknown error"}),w({scope:"overview",kind:"error",message:"evalInInspectedPage failed",meta:{error:d.error||"unknown error"}});return}const b=d.value;if(!b||b.ok!==!0){const k=String((b==null?void 0:b.error)||"unknown snapshot error");u("Snapshot error"),s(!0),C({kind:"error",scope:"overview",message:"Metric snapshot from page returned an error.",ok:!1,error:k}),w({scope:"overview",kind:"error",message:"snapshot returned ok=false",meta:{error:k,snap:b}});return}const y={domNodes:x(b.domNodes,0),resTotal:x(b.resTotal,0),errTotal:x(b.errTotal,0),longTaskTotal:x(b.longTaskTotal,0)};o.setSample(mt(),y),t.render(o.totals,o.rates,o.baselineDomNodes);const D=o.rates;if(D&&o.totals){const k=ct({dom:o.totals.domNodes,resPerMin:D.resPerMin,errPerMin:D.errPerMin,longPerMin:D.longTaskPerMin});o.pushPoint({t:Date.now(),dom:o.totals.domNodes,resPerMin:D.resPerMin,errPerMin:D.errPerMin,longPerMin:D.longTaskPerMin,stress:k}),t.renderCharts(o.points),w({scope:"overview",kind:"debug",message:"point",meta:o.points[o.points.length-1]})}u("Monitoring"),s(!0),w({scope:"overview",kind:"debug",message:"sample",meta:y})}function f(){r==null&&(o.clearPoints(),o.clearBaseline(),o.setEnabled(!0),u("Starting…"),s(!0),c().catch(()=>null),r=window.setInterval(()=>{c().catch(()=>null)},z),C({kind:"run",scope:"overview",message:"Monitoring started.",ok:!0,meta:{pollMs:z}}),w({scope:"overview",kind:"debug",message:"polling:start",meta:{pollMs:z}}))}function E(){r!=null&&(window.clearInterval(r),r=null),o.setEnabled(!1),u("Idle"),s(!1),C({kind:"run",scope:"overview",message:"Monitoring stopped.",ok:!0}),w({scope:"overview",kind:"debug",message:"polling:stop"})}async function v(){if(h()){u("Busy"),s(o.enabled);return}o.enabled||f()}async function m(){if(h()){u("Busy"),s(o.enabled);return}o.enabled&&E()}const g=n.on(()=>{});function i(){a||(a=!0,e.btnOvStart.addEventListener("click",()=>{v().catch(()=>null)}),e.btnOvStop.addEventListener("click",()=>{m().catch(()=>null)}))}return{id:"overview",refresh(){h()||c().catch(()=>null)},mount(){l=!0,t.setEmpty(),u(o.enabled?"Monitoring":"Idle"),s(o.enabled)},unmount(){l=!1,E()},bind:i,dispose(){E(),g()}}}function L(e,n,o,t){const r=Number(String(e??"").trim());return Number.isFinite(r)?Math.max(n,Math.min(o,Math.floor(r))):t}const J="beezy-monitor.devConfig",S={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50};let Y=!1,G={...S};function ve(e){const n=e||{};return{traceConsole:!!n.traceConsole,actionLogMax:L(n.actionLogMax??S.actionLogMax,100,5e4,S.actionLogMax),debugTraceMax:L(n.debugTraceMax??S.debugTraceMax,100,5e4,S.debugTraceMax),failureLogsPerRun:L(n.failureLogsPerRun??S.failureLogsPerRun,0,5e4,S.failureLogsPerRun)}}async function ne(){if(Y)return;const e=await R([J]).catch(()=>({}));G=ve(e==null?void 0:e[J]),Y=!0}function oe(){return G}async function me(e){G=ve(e),Y=!0,await A({[J]:G}).catch(()=>null)}async function Dt(){await me({...S})}function yt(){let e=!1,n={traceConsole:!1,actionLogMax:5e3,debugTraceMax:2e3,failureLogsPerRun:50},o=!1,t="",r="";function l(c){e=c}function a(c){n={...n,...c}}function s(c){o=c}function u(c){typeof c.general=="string"&&(t=c.general),typeof c.dev=="string"&&(r=c.dev)}return{get showDevTools(){return e},get dev(){return n},get debugEnabled(){return o},get generalStatus(){return t},get devStatus(){return r},setShowDevTools:l,setDev:a,setDebugEnabled:s,setStatus:u}}function wt(e){function n(c){e.settingsGeneralStatusEl.textContent=c||""}function o(c){e.cfgStatusEl.textContent=c||""}function t(c){e.cfgShowDevToolsEl.checked=c}function r(c){e.tabLogs.hidden=!c,e.devConfigDetailsEl.classList.toggle("is-hidden",!c),c||(e.viewLogs.hidden=!0,e.viewSettings.hidden=!1,e.devConfigDetailsEl.open=!1)}function l(c){e.cfgTraceConsoleEl.checked=!!c.traceConsole,e.cfgActionLogMaxEl.value=String(c.actionLogMax??5e3),e.cfgDebugTraceMaxEl.value=String(c.debugTraceMax??2e3),e.cfgFailureLogsPerRunEl.value=String(c.failureLogsPerRun??50)}function a(c){e.logsCbDebugEl.checked=c}function s(c,f){e.settingsVersionEl.textContent=c||"—",e.settingsGitHubLinkEl.href=f||"#",e.settingsGitHubLinkEl.hidden=!f}function u(c){e.cfgShowDevToolsEl.disabled=!1,e.cfgTraceConsoleEl.disabled=c,e.cfgActionLogMaxEl.disabled=c,e.cfgDebugTraceMaxEl.disabled=c,e.cfgFailureLogsPerRunEl.disabled=c,e.btnCfgResetDefaults.disabled=c,e.logsCbDebugEl.disabled=c}return{setGeneralStatus:n,setDevStatus:o,setShowDevToolsChecked:t,setDevToolsVisible:r,setDevConfig:l,setDebugEnabledChecked:a,setAbout:s,setBusy:u}}const U="template.settings.showDevTools";function Tt(){var e,n;try{const o=(e=globalThis==null?void 0:globalThis.chrome)==null?void 0:e.runtime,t=(n=o==null?void 0:o.getManifest)==null?void 0:n.call(o),r=typeof(t==null?void 0:t.version)=="string"?t.version:"";if(r)return r}catch{}return""}function K(e){return{traceConsole:!!e.traceConsole,actionLogMax:Number(e.actionLogMax??S.actionLogMax),debugTraceMax:Number(e.debugTraceMax??S.debugTraceMax),failureLogsPerRun:Number(e.failureLogsPerRun??S.failureLogsPerRun)}}function Ct(e){return{traceConsole:!!e.cfgTraceConsoleEl.checked,actionLogMax:L(e.cfgActionLogMaxEl.value,100,5e4,S.actionLogMax),debugTraceMax:L(e.cfgDebugTraceMaxEl.value,100,5e4,S.debugTraceMax),failureLogsPerRun:L(e.cfgFailureLogsPerRunEl.value,0,5e4,S.failureLogsPerRun)}}async function re(e){const n=fe;return typeof n.setEnabled=="function"?(await n.setEnabled(e),{ok:!0}):typeof n.enable=="function"&&typeof n.disable=="function"?(await(e?n.enable():n.disable()),{ok:!0}):{ok:!1,error:"debugTrace has no setEnabled/enable/disable API."}}function Lt(e,n){const o=yt(),t=wt(e);async function r(){const i=await R([U]).catch(()=>({}));return(i==null?void 0:i[U])===!0}async function l(i){await A({[U]:!!i}).catch(()=>null)}function a(i){o.setShowDevTools(i),t.setShowDevToolsChecked(i),t.setDevToolsVisible(i),i||e.tabSettings.click()}async function s(){const i=await r();a(i),w({scope:"settings",kind:"debug",message:"boot:applyDevToolsVisibility",meta:{showDevTools:i}})}async function u(){var D;t.setBusy(h());const i=await r();a(i),await ne().catch(()=>null);const d=oe();o.setDev(K(d)),t.setDevConfig(o.dev);const b=fe,y=typeof b.isEnabled=="function"?!!b.isEnabled():!!b.enabled;o.setDebugEnabled(y),t.setDebugEnabledChecked(y),t.setAbout(Tt()||"—",((D=e.settingsGitHubLinkEl)==null?void 0:D.href)||"#"),t.setGeneralStatus(""),t.setDevStatus("")}async function c(){const i=!!e.cfgShowDevToolsEl.checked;a(i),await l(i),C({kind:"run",scope:"settings",message:i?"Developer tools enabled (Logs visible).":"Developer tools disabled (Logs hidden).",ok:!0,meta:{showDevTools:i}}),w({scope:"settings",kind:"debug",message:"ui:toggle showDevTools",meta:{showDevTools:i}}),t.setGeneralStatus(i?"Developer tools enabled.":"Developer tools disabled."),setTimeout(()=>t.setGeneralStatus(""),1200)}async function f(){const i=Ct(e);t.setDevStatus("Saving…"),await me(i),o.setDev(K(i)),t.setDevConfig(o.dev),C({kind:"run",scope:"settings",message:"Developer configuration updated.",ok:!0,meta:i}),w({scope:"settings",kind:"debug",message:"devConfig:updated",meta:i}),t.setDevStatus("Saved."),setTimeout(()=>t.setDevStatus(""),1200)}async function E(){t.setDevStatus("Resetting…"),await Dt(),await ne().catch(()=>null);const i=oe();o.setDev(K(i)),t.setDevConfig(o.dev);const d=await re(!1);d.ok?(o.setDebugEnabled(!1),t.setDebugEnabledChecked(!1)):C({kind:"error",scope:"settings",message:"Dev defaults reset, but failed to reset debug enabled state.",ok:!1,error:d.error||"unknown error"}),C({kind:"run",scope:"settings",message:"Developer configuration reset to defaults (debug disabled).",ok:!0,meta:{...S,debugEnabled:!1}}),t.setDevStatus("Reset."),setTimeout(()=>t.setDevStatus(""),1200)}async function v(){const i=!!e.logsCbDebugEl.checked;t.setDevStatus("Saving…");const d=await re(i);if(!d.ok){e.logsCbDebugEl.checked=!i,t.setDevStatus(`Save failed: ${d.error||"unknown error"}`),C({kind:"error",scope:"settings",message:"Failed to change debug trace enabled state.",ok:!1,error:d.error||"unknown error",meta:{enabled:i}});return}o.setDebugEnabled(i),C({kind:"run",scope:"settings",message:i?"Debug trace enabled.":"Debug trace disabled (debug traces cleared).",ok:!0,meta:{enabled:i}}),w({scope:"settings",kind:"debug",message:"debugTrace:enabledChanged",meta:{enabled:i}}),t.setDevStatus("Saved."),setTimeout(()=>t.setDevStatus(""),1200)}const m=n.on(()=>{});function g(){e.cfgShowDevToolsEl.addEventListener("change",()=>{c()}),e.cfgTraceConsoleEl.addEventListener("change",()=>{h()||f()}),e.cfgActionLogMaxEl.addEventListener("change",()=>{h()||f()}),e.cfgDebugTraceMaxEl.addEventListener("change",()=>{h()||f()}),e.cfgFailureLogsPerRunEl.addEventListener("change",()=>{h()||f()}),e.btnCfgResetDefaults.addEventListener("click",()=>{h()||E()}),e.logsCbDebugEl.addEventListener("change",()=>{h()||v()}),s().catch(()=>null)}return{id:"settings",refresh(){u().catch(()=>null)},mount(){u().catch(()=>null)},unmount(){},bind:g,dispose(){m()}}}function kt(){let e=[],n=0;function o(t){e=t.items,n=t.total}return{get items(){return e},get total(){return n},set:o}}function pt(e){try{return new Date(e).toLocaleString()}catch{return String(e)}}function se(e,n){const o=[];o.push(`Total entries: ${n.total}`),o.push("");for(const t of n.items){const r=typeof t.ok=="boolean"?t.ok?"ok":"fail":"",l=[];typeof t.status=="number"&&l.push(`status=${t.status}`),r&&l.push(r);const a=[t.scope,t.kind].filter(Boolean).join("/");o.push(`[${pt(t.ts)}] ${a}${l.length?` (${l.join(", ")})`:""}`),o.push(`  ${t.message}`),t.error&&o.push(`  error: ${t.error}`),o.push("")}e.textContent=o.join(`
`),e.scrollTop=0}function Mt(e){function n(a){e.logsStatusEl.textContent=a}function o(a){e.debugStatusEl.textContent=a}function t(a){e.logsCbDebugEl.checked=a}function r(a){se(e.logsOutEl,{total:a.total,items:a.items.map(s=>({ts:s.ts,message:s.message,scope:s.scope,kind:s.kind,ok:s.ok,status:s.status,error:s.error,meta:s.meta}))})}function l(a){se(e.debugOutEl,{total:a.total,items:a.items.map(s=>({ts:s.ts,message:s.message,scope:s.scope,kind:s.kind,ok:s.ok,status:s.status,error:s.error,meta:s.meta}))})}return{setAuditStatus:n,setDebugStatus:o,setDebugChecked:t,renderAudit:r,renderDebug:l}}const ae="beezy-monitor";function It(e,n){const o=kt(),t=Mt(e);async function r(){t.setAuditStatus("Loading…"),T(e,!0);try{const g=L(e.logsLimitEl.value,10,5e3,200),i=await tt({limit:g,reverse:!0});o.set(i),t.renderAudit({items:o.items,total:o.total}),t.setAuditStatus(`Showing ${o.items.length} (newest first)`)}catch(g){t.setAuditStatus(`Failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{T(e,!1)}}async function l(){t.setDebugStatus("Loading…"),T(e,!0);try{const g=L(e.debugLimitEl.value,10,5e3,200),i=await ge({limit:g,reverse:!0});t.renderDebug(i),t.setDebugStatus(`Showing ${i.items.length} (newest first)`)}catch(g){t.setDebugStatus(`Failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{T(e,!1)}}async function a(){const g=await q();t.setDebugChecked(g)}async function s(g){if(await ce(g),t.setDebugChecked(g),!g){t.setDebugStatus("Debug OFF. Traces wiped."),e.debugOutEl.textContent="";return}t.setDebugStatus("Debug ON."),await l()}async function u(){const g=L(e.logsTrimKeepEl.value,0,5e4,2e3);t.setAuditStatus("Trimming…"),T(e,!0);try{const i=await nt({keepLast:g});await r(),t.setAuditStatus(`Trimmed. Remaining: ${i.total}`)}catch(i){t.setAuditStatus(`Trim failed: ${(i==null?void 0:i.message)||String(i)}`)}finally{T(e,!1)}}async function c(){t.setAuditStatus("Clearing…"),T(e,!0);try{await ot(),await r(),t.setAuditStatus("Cleared.")}catch(g){t.setAuditStatus(`Clear failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{T(e,!1)}}async function f(){t.setAuditStatus("Exporting…");try{const g=await rt({pretty:!0}),i=new Blob([g],{type:"application/json"}),d=URL.createObjectURL(i),b=document.createElement("a");b.href=d,b.download=`${ae}-audit-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(d),1e3),t.setAuditStatus("Exported.")}catch(g){t.setAuditStatus(`Export failed: ${(g==null?void 0:g.message)||String(g)}`)}}async function E(){t.setDebugStatus("Clearing…"),T(e,!0);try{await ue(),await l(),t.setDebugStatus("Cleared.")}catch(g){t.setDebugStatus(`Clear failed: ${(g==null?void 0:g.message)||String(g)}`)}finally{T(e,!1)}}async function v(){t.setDebugStatus("Exporting…");try{const g=await de({pretty:!0}),i=new Blob([g],{type:"application/json"}),d=URL.createObjectURL(i),b=document.createElement("a");b.href=d,b.download=`${ae}-debug-${Date.now()}.json`,b.click(),setTimeout(()=>URL.revokeObjectURL(d),1e3),t.setDebugStatus("Exported.")}catch(g){t.setDebugStatus(`Export failed: ${(g==null?void 0:g.message)||String(g)}`)}}function m(){e.btnLogsRefresh.addEventListener("click",()=>{h()||r()}),e.btnLogsTrim.addEventListener("click",()=>{h()||u()}),e.btnLogsClear.addEventListener("click",()=>{h()||c()}),e.btnLogsExport.addEventListener("click",()=>{h()||f()}),e.logsCbDebugEl.addEventListener("change",()=>{h()||s(e.logsCbDebugEl.checked)}),e.btnDebugRefresh.addEventListener("click",()=>{h()||l()}),e.btnDebugClear.addEventListener("click",()=>{h()||E()}),e.btnDebugExport.addEventListener("click",()=>{h()||v()})}return{id:"logs",bind:m,mount(){a(),r(),l()},unmount(){},dispose(){}}}(function(){const n=Ue(),o=We();o.start();const t=Ye();globalThis.__APP__={...globalThis.__APP__,cache:t};const r=St(n,o),l=Lt(n,o),a=It(n);r.bind(),l.bind(),a.bind();const s=Je(n,{overview:r,settings:l,logs:a});s.bind(),s.boot()})();
